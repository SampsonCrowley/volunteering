class Soda

  STATES = {
    "National" =>         {
                          main: "pz9s-gsz3",
                          vl_rate: "5wad-rqhr",
                          perc_don: nil
                        },

    "Alabama" =>          {
                          main: "rpcs-x4hb",
                          vl_rate: "77nx-htyh",
                          perc_don: "xm39-hjbe"

                        },

  	"Alaska" =>           {
                          main: "6cra-6bsr",
                          vl_rate: "fmyn-cwrc",
                          perc_don: "c59r-c7m7"
                        },

  	"Arizona" =>           {
                          main: "rhfm-rcgr",
                          vl_rate: "34yv-jh8z",
                          perc_don: "gxmf-3gr2"
                        },

  	"Arkansas" =>          {
                          main: "iwsf-v24f",
                          vl_rate: "6zsn-338f",
                          perc_don: "utqq-7sdh"
                        },

  	"California" =>        {
                          main: "pvah-jb5g",
                          vl_rate: "5vsv-a6z9",
                          perc_don: "4zrt-nrsp"
                        },

  	"Colorado" =>          {
                          main: "6hcc-vvir",
                          vl_rate: "5zqn-yyn9",
                          perc_don: "gti8-digh"
                        },

  	"Connecticut" =>       {
                          main: "mxju-48pr",
                          vl_rate: "mtny-y8vw",
                          perc_don: "k86w-mu8i"
                        },

  	"Delaware" =>          {
                          main: "tfrh-eycc",
                          vl_rate: "hh59-uy42",
                          perc_don: "ih45-24q9"
                        },

  	"District of Columbia" => {
                          main: "9fsr-q9if",
                          vl_rate: "udvg-5ev6",
                          perc_don: "erzm-wzfw"
                        },

  	"Florida" =>           {
                          main: "nvuq-vvhu",
                          vl_rate: "vmr8-7muu",
                          perc_don: "2jbk-g63g"
                        },

  	"Georgia" =>           {
                          main: "bdyn-jgqi",
                          vl_rate: "cm6s-2hrx",
                          perc_don: "5dge-dpen"
                        },

  	"Hawaii" =>            {
                          main: "r8u9-52wb",
                          vl_rate: "jxba-enek",
                          perc_don: "j5ug-66vr"
                        },

  	"Idaho" =>             {
                          main: "udhx-7h28",
                          vl_rate: "7ina-bmqg",
                          perc_don: "fb89-7cn5"
                        },

  	"Illinois" =>          {
                          main: "gdxd-nqvh",
                          vl_rate: "3biw-jcp6",
                          perc_don: "ure4-s5eu"
                        },

  	"Indiana" =>           {
                          main: "3yzb-q8hi",
                          vl_rate: "2vqk-u4hj",
                          perc_don: "f5y6-amz3"
                        },

  	"Iowa" =>              {
                          main: "dhsi-bwde",
                          vl_rate: "w4f5-qfuf",
                          perc_don: "qmxr-rysr"
                        },

  	"Kansas" =>            {
                          main: "fhr3-sna2",
                          vl_rate: "6pvz-nyfz",
                          perc_don: "9fk7-7pv6"
                        },

  	"Kentucky" =>          {
                          main: "52xd-dn42",
                          vl_rate: "wcet-59ms",
                          perc_don: "3q79-vij5"
                        },

  	"Louisiana" =>         {
                          main: "mby6-c5s9",
                          vl_rate: "2xyp-tsf3",
                          perc_don: "sgre-i8c7"
                        },

  	"Maine" =>             {
                          main: "mi8z-tz2k",
                          vl_rate: "pb4i-2qhj",
                          perc_don: "ea77-7ayg"
                        },

  	"Maryland" =>          {
                          main: "xusy-5u5f",
                          vl_rate: "9mfj-wwbt",
                          perc_don: "ukct-y4tq"
                        },

  	"Massachusetts" =>     {
                          main: "k4m6-dw2r",
                          vl_rate: "n3gu-e58p",
                          perc_don: "deb3-k4m6"
                        },

  	"Michigan" =>          {
                          main: "49da-3f5i",
                          vl_rate: "gw5f-fpy8",
                          perc_don: "7ab6-svec"
                        },

  	"Minnesota" =>         {
                          main: "frmt-xidf",
                          vl_rate: "7n3y-t9k3",
                          perc_don: "sqbe-c9vk"
                        },

  	"Mississippi" =>       {
                          main: "nn3v-3j5a",
                          vl_rate: "2n2c-9vva",
                          perc_don: "cps5-i9ii"
                        },

  	"Missouri" =>          {
                          main: "4pjc-c4n3",
                          vl_rate: "vd64-bkwd",
                          perc_don: "kxf8-ksn9"
                        },

  	"Montana" =>           {
                          main: "xi6a-f34f",
                          vl_rate: "q3rh-izmu",
                          perc_don: "2978-qpgq"
                        },

  	"Nebraska" =>          {
                          main: "8sqv-33jb",
                          vl_rate: "h5hs-nbgi",
                          perc_don: "pmzs-33dq"
                        },

  	"Nevada" =>            {
                          main: "ht3b-dbkk",
                          vl_rate: "hxv9-uguj",
                          perc_don: "ry73-nzrq"
                        },

  	"New Hampshire" =>     {
                          main: "hb57-sew3",
                          vl_rate: "4ksy-2q2i",
                          perc_don: "7m9t-rih9"
                        },

  	"New Jersey" =>        {
                          main: "s9g8-ajpt",
                          vl_rate: "tbmk-fe6h",
                          perc_don: "gvgh-uxtt"
                        },

  	"New Mexico" =>        {
                          main: "5ari-z7i6",
                          vl_rate: "qncu-z9r6",
                          perc_don: "west-8pjz"
                        },

  	"New York" =>          {
                          main: "ezit-atvu",
                          vl_rate: "2cwj-u3nv",
                          perc_don: "hxis-3izg"
                        },

  	"North Carolina" =>    {
                          main: "3tw3-njaz",
                          vl_rate: "vxdc-7b5r",
                          perc_don: "92sa-5y84"
                        },

  	"North Dakota" =>      {
                          main: "9cha-w57y",
                          vl_rate: "cb88-be2u",
                          perc_don: "nhuk-hpmp"
                        },

  	"Ohio" =>              {
                          main: "tbag-ib8t",
                          vl_rate: "kcwy-icx6",
                          perc_don: "kj9r-bsbr"
                        },

  	"Oklahoma" =>          {
                          main: "68i8-6as4",
                          vl_rate: "nugs-cbyr",
                          perc_don: "ttsm-phwz"
                        },

  	"Oregon" =>            {
                          main: "mu9b-htfk",
                          vl_rate: "8xdw-zzgb",
                          perc_don: "y4b2-8uk9"
                        },

  	"Pennsylvania" =>      {
                          main: "ph4u-94ai",
                          vl_rate: "y9h3-p997",
                          perc_don: "dx3r-z5ai"
                        },

  	"Rhode Island" =>      {
                          main: "2ega-f9dr",
                          vl_rate: "iarv-rau3",
                          perc_don: "m4az-midj"
                        },

  	"South Carolina" =>    {
                          main: "pn6q-57yk",
                          vl_rate: "mzbf-xu8w",
                          perc_don: "53dg-dysu"
                        },

  	"South Dakota" =>      {
                          main: "hmdh-n3je",
                          vl_rate: "qkk7-rzkr",
                          perc_don: "jhx9-b5r5"
                        },

  	"Tennessee" =>         {
                          main: "wezb-ypmu",
                          vl_rate: "9p7u-hyhq",
                          perc_don: "d2kj-qxn5"
                        },

  	"Texas" =>             {
                          main: "cwmr-tcae",
                          vl_rate: "ytqz-9swv",
                          perc_don: "9bud-v5jk"
                        },

  	"Utah" =>              {
                          main: "xhyh-88mc",
                          vl_rate: "ebhe-82up",
                          perc_don: "xkhn-zqqg"
                        },

  	"Vermont" =>           {
                          main: "5cjz-kf32",
                          vl_rate: "9yt2-bbri",
                          perc_don: "au38-nzja"
                        },

  	"Virginia" =>          {
                          main: "x5fr-gthr",
                          vl_rate: "93xe-nb8z",
                          perc_don: "nzr4-kih7"
                        },

  	"Washington" =>        {
                          main: "ead4-6pvk",
                          vl_rate: "5cs2-j4zk",
                          perc_don: "9dwa-qxim"
                        },

  	"West Virginia" =>     {
                          main: "u459-ybv3",
                          vl_rate: "rcsp-zmam",
                          perc_don: "hmfe-vuxk"
                        },

  	"Wisconsin" =>         {
                          main: "pqxu-7nbv",
                          vl_rate: "9e7z-dgph",
                          perc_don: "vbmp-zqex"
                        },

  	"Wyoming" =>           {
                          main: "24xw-zi2q",
                          vl_rate: "jccd-n53z",
                          perc_don: "2fme-ad9g"
                        }
  }

  def initialize
    @client = SODA::Client.new({domain: "data.nationalservice.gov", app_token: Rails.application.secrets.soda_key})
  end

  def search
    STATES.map do |state, dataset|
      state_stat = StateStat.find_by(state: state)
      if state_stat
        update_db(state_stat)
      else
        add_to_db(state, dataset[:main], dataset[:vl_rate], dataset[:perc_don])
      end
    end
  end

  def add_to_db(state, main, vl, pt)
    update_db(StateStat.create(
                  state: state,
                  main_ds: main,
                  main_mt: [],
                  vl_rate_ds: vl,
                  vl_rate_mt: [],
                  perc_ds: pt,
                  perc_mt: []
                )
              )
  end

  def update_db(state)
    main_metrics = []
    if state.main_ds
      main_records = @client.get(state.main_ds, {:$limit => 5000})
      main_records.each do |record|
        main_metrics << [record.value_name, (record.metric.to_f * 100).round(2)]
      end
    end

    vl_rate_metrics = []
    if state.vl_rate_ds
      vl_rate_records = @client.get(state.vl_rate_ds, {:$limit => 5000})
      vl_rate_records.each do |record|
        vl_rate_metrics << [record.year, record.value_name, (record.metric.to_f * 100).round(2)]
      end
    end

    perc_metrics = []
    if state.perc_ds
      perc_records = @client.get(state.perc_ds, {:$limit => 5000})
      perc_records.each do |record|
        perc_metrics << [record.value_name, (record.metric.to_f * 100).round(2)]
      end
    end

    state.update(
      main_mt: main_metrics,
      vl_rate_mt: vl_rate_metrics,
      perc_mt: perc_metrics,
    )
  end

  def get_metrics(dataset)

    metrics
  end

  def detailed(state)
    state_stat = StateStat.find_by(state: state)
    main_breakup = state_stat.main_mt
    voluteer_rate = state_stat.vl_rate_mt
    percent_donating = state_stat.perc_mt
    [main_breakup, voluteer_rate, percent_donating]
  end

end
